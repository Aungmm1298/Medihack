<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ผู้ป่วย / Patient Dashboard - Patient Flow Analytics System</title>
    <link rel="icon" type="image/png" href="images/mfu-logo.png">
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-header">
                <div class="navbar-brand">
                    <div class="navbar-logo">
                        <img src="images/mfu-logo.png" alt="MFU Logo" onerror="this.style.display='none'">
                    </div>
                    <div class="logo-divider"></div>
                    <div class="navbar-title">
                        <h1>โรงพยาบาลศูนย์การแพทย์มหาวิทยาลัยแม่ฟ้าหลวง</h1>
                        <p>MAE FAH LUANG UNIVERSITY MEDICAL CENTER HOSPITAL - Patient Portal</p>
                    </div>
                </div>
                <div class="navbar-logo-right">
                    <div class="mfu-logo-text">MFU<br>MCH</div>
                </div>
            </div>
            <div class="navbar-menu-wrapper">
                <ul class="navbar-menu">
                    <li><a href="patient-dashboard.html">Dashboard</a></li>
                    <li><a href="#" id="userName" style="background-color: rgba(0, 0, 0, 0.1); font-weight: 600;">Patient</a></li>
                    <li><a href="#" onclick="logout()" style="background-color: var(--alert-red); font-weight: 600;">Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Sidebar Backdrop for mobile -->
    <div class="sidebar-backdrop" onclick="toggleSidebar()"></div>

    <!-- Dashboard Layout -->
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <ul class="sidebar-menu">
                <li><a href="#overview" class="active" id="overviewLink" onclick="showOverview(); return false;">ภาพรวม / Overview</a></li>
                <li><a href="#queue" id="queueLink" onclick="showQueue(); return false;">ตรวจสอบคิว / Check Queue</a></li>
                <li><a href="#progress" id="progressLink" onclick="showProgress(); return false;">ตรวจสอบความคืบหน้า / Check Progress</a></li>
                <li><a href="#instructions" id="instructionsLink" onclick="showInstructions(); return false;">คำแนะนำแพทย์ / Doctor Instructions</a></li>
                <li><a href="#history" id="historyLink" onclick="showPatientHistory(); return false;">ประวัติการรักษา / Medical History</a></li>
                <li><a href="#reschedule" id="rescheduleLink" onclick="showSmartReschedule(); return false;">นัดหมายอัจฉริยะ / Smart Rescheduling</a></li>
                <li><a href="#waittime" id="waittimeLink" onclick="showWaitTime(); return false;">เวลารอ AI & แจ้งเตือน / AI Wait Time & Alerts</a></li>
                <li><a href="#map" id="mapLink" onclick="showMap(); return false;">แผนที่ / View Map</a></li>
            </ul>
        </aside>

        <!-- Mobile Menu Toggle -->
        <button class="mobile-sidebar-toggle" onclick="toggleSidebar()" aria-label="Toggle menu">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <h2 style="color: var(--mfu-green); margin-bottom: 1.5rem;">แดชบอร์ดผู้ป่วย / Patient Dashboard</h2>
            
            <!-- Welcome Card -->
            <div class="card" style="background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%); border-left: 6px solid var(--mfu-green);">
                <h3 style="color: var(--mfu-green); margin-bottom: 1rem;">ยินดีต้อนรับ / Welcome</h3>
                <p style="color: var(--text-secondary); font-size: 1.125rem; line-height: 1.6;">
                    ระบบจะเพิ่มฟีเจอร์ต่างๆ เร็วๆ นี้<br>
                    Features will be added soon
                </p>
            </div>
        </main>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div>
                <h4>Patient Flow Analytics System</h4>
                <p>Mae Fah Luang University Medical Center Hospital</p>
            </div>
            <div>
                <h4>ติดต่อเรา / Contact</h4>
                <p>โทร: 053-916-999</p>
                <p>Email: info@mfumch.ac.th</p>
            </div>
            <div>
                <h4>Quick Links</h4>
                <p><a href="#">ช่วยเหลือ / Help</a></p>
                <p><a href="#">คำถามที่พบบ่อย / FAQ</a></p>
            </div>
            <div>
                <h4>ระบบ / System</h4>
                <p>Version 1.0.0</p>
                <p>© 2026 MFU Medical Center</p>
            </div>
        </div>
    </footer>

    <!-- External Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/database-service.js"></script>

    <script>
        // Check if user is logged in
        if (sessionStorage.getItem('loggedIn') !== 'true' || sessionStorage.getItem('userRole') !== 'patient') {
            window.location.href = 'login.html?role=patient';
        }

        // Display user name
        const userId = sessionStorage.getItem('userId');
        if (userId) {
            document.getElementById('userName').textContent = userId;
        }

        // Initialize database service
        (async function initDatabaseService() {
            try {
                await window.databaseService.init();
                console.log('Database service initialized successfully');
            } catch (error) {
                console.error('Failed to initialize database service:', error);
            }
        })();

        // Logout function
        function logout() {
            if (confirm('ต้องการออกจากระบบหรือไม่? / Do you want to logout?')) {
                sessionStorage.clear();
                window.location.href = 'index.html';
            }
        }

        // Toggle sidebar on mobile
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const toggle = document.querySelector('.mobile-sidebar-toggle');
            const backdrop = document.querySelector('.sidebar-backdrop');
            sidebar.classList.toggle('active');
            toggle.classList.toggle('active');
            backdrop.classList.toggle('active');
        }

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(event) {
            const sidebar = document.querySelector('.sidebar');
            const toggle = document.querySelector('.mobile-sidebar-toggle');
            const backdrop = document.querySelector('.sidebar-backdrop');
            const isClickInsideSidebar = sidebar && sidebar.contains(event.target);
            const isClickOnToggle = toggle && toggle.contains(event.target);
            
            if (!isClickInsideSidebar && !isClickOnToggle && sidebar && sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                toggle.classList.remove('active');
                backdrop.classList.remove('active');
            }
        });

        // Close sidebar when clicking a menu item on mobile
        document.querySelectorAll('.sidebar-menu a').forEach(link => {
            link.addEventListener('click', function() {
                if (window.innerWidth <= 768) {
                    const sidebar = document.querySelector('.sidebar');
                    const toggle = document.querySelector('.mobile-sidebar-toggle');
                    const backdrop = document.querySelector('.sidebar-backdrop');
                    if (sidebar && toggle && backdrop) {
                        sidebar.classList.remove('active');
                        toggle.classList.remove('active');
                        backdrop.classList.remove('active');
                    }
                }
            });
        });

        // Update active menu
        function updateActiveMenu(activeId) {
            const menuIds = ['overviewLink', 'queueLink', 'progressLink', 'instructionsLink', 'historyLink', 'rescheduleLink', 'waittimeLink', 'mapLink'];
            menuIds.forEach(id => {
                document.getElementById(id).classList.remove('active');
            });
            document.getElementById(activeId).classList.add('active');
        }

        // Show Overview
        function showOverview() {
            updateActiveMenu('overviewLink');
            
            document.getElementById('mainContent').innerHTML = `
                <h2 style="color: var(--mfu-green); margin-bottom: 1.5rem;">แดชบอร์ดผู้ป่วย / Patient Dashboard</h2>
                
                <div class="card" style="background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%); border-left: 6px solid var(--mfu-green);">
                    <h3 style="color: var(--mfu-green); margin-bottom: 1rem;">ยินดีต้อนรับ / Welcome</h3>
                    <p style="color: var(--text-secondary); font-size: 1.125rem; line-height: 1.6;">
                        ระบบจะเพิ่มฟีเจอร์ต่างๆ เร็วๆ นี้<br>
                        Features will be added soon
                    </p>
                </div>
            `;
        }

        // Show Queue
        function showQueue() {
            updateActiveMenu('queueLink');
            
            document.getElementById('mainContent').innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.25rem; flex-wrap: wrap;">
                    <button onclick="showOverview()" style="background: var(--mfu-green); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 0.4rem; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.background='var(--mfu-green-dark)'; this.style.transform='translateX(-3px)'" onmouseout="this.style.background='var(--mfu-green)'; this.style.transform='translateX(0)'">
                        <span style="font-size: 1.1rem;">←</span>
                        <span>กลับ / Back</span>
                    </button>
                    <h2 style="color: var(--mfu-green); margin: 0;">ตรวจสอบคิว / Check Queue</h2>
                </div>
                
                <!-- Alert for current queue status -->
                <div class="alert alert-success" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: #d1fae5; border: 1px solid #10b981; border-radius: 8px; margin-bottom: 1.5rem;">
                    <div>
                        <strong style="color: #065f46;">คุณอยู่ในคิว / You are in the queue</strong><br>
                        <span style="color: #047857;">หมายเลขคิวของคุณจะถูกเรียกในอีกประมาณ <strong id="waitTimeAlert">15 นาที</strong> / Your queue number will be called in about <strong>15 minutes</strong></span>
                    </div>
                </div>

                <!-- Current Queue Status Card -->
                <div class="card" style="background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%); border-left: 6px solid var(--mfu-green);">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 2rem;">
                        <div>
                            <h3 style="color: var(--text-secondary); font-size: 1.125rem; font-weight: 500; margin-bottom: 0.5rem;">
                                หมายเลขคิวของคุณ / Your Queue Number
                            </h3>
                            <div style="font-size: 5rem; font-weight: 700; color: var(--mfu-green); line-height: 1;">
                                A-042
                            </div>
                            <p style="color: var(--text-secondary); font-size: 1.125rem; margin-top: 0.5rem;">
                                แผนก OPD / Outpatient Department
                            </p>
                        </div>
                        <div style="text-align: right;">
                            <h4 style="color: var(--text-secondary); font-size: 1.125rem; margin-bottom: 0.5rem;">
                                เวลารอโดยประมาณ<br>Estimated Wait Time
                            </h4>
                            <div style="font-size: 4rem; font-weight: 700; color: var(--gold-nav); line-height: 1;">
                                15<span style="font-size: 2rem;"> นาที</span>
                            </div>
                            <div style="font-size: 1.75rem; color: var(--text-secondary);">
                                15 minutes
                            </div>
                            <p style="color: var(--text-secondary); font-size: 0.95rem; margin-top: 1rem;">
                                ทำนายโดย AI / Predicted by AI
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Queue Progress -->
                <div class="card" style="margin-top: 2rem;">
                    <div class="card-header">
                        <h3 class="card-title">ความคืบหน้า / Queue Progress</h3>
                    </div>
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                            <span style="font-size: 1.125rem;">คิวปัจจุบัน / Current Queue: <strong>A-038</strong></span>
                            <span style="font-size: 1.125rem;">คิวของคุณ / Your Queue: <strong>A-042</strong></span>
                        </div>
                        <div style="background-color: var(--bg-gray); height: 30px; border-radius: 15px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, var(--mfu-green) 0%, var(--mfu-green-light) 100%); height: 100%; width: 75%; transition: width 0.5s ease;"></div>
                        </div>
                        <p style="text-align: center; color: var(--text-secondary); margin-top: 0.75rem; font-size: 1.125rem;">
                            เหลืออีก 4 คน / 4 patients ahead
                        </p>
                    </div>
                </div>

                <!-- Real-time Queue Display -->
                <div class="card" style="margin-top: 2rem;">
                    <div class="card-header">
                        <h3 class="card-title">คิวปัจจุบัน / Current Queue</h3>
                    </div>
                    <div class="queue-list">
                        <div class="queue-item" style="background-color: #D1FAE5; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--mfu-green); min-width: 80px;">A-038</div>
                            <div style="flex: 1; padding: 0 1rem;">
                                <h4 style="margin: 0 0 0.25rem 0; font-size: 1rem;">กำลังรับบริการ / Currently Serving</h4>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">ห้องตรวจ 3 / Room 3 - Dr. สมชาย วรรณสุข</p>
                            </div>
                            <div style="text-align: right;">
                                <span style="background: #10B981; color: white; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; font-weight: 600; white-space: nowrap;">กำลังตรวจ / In Progress</span>
                            </div>
                        </div>

                        <div class="queue-item" style="padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border-gray);">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-secondary); min-width: 80px;">A-039</div>
                            <div style="flex: 1; padding: 0 1rem;">
                                <h4 style="margin: 0 0 0.25rem 0; font-size: 1rem;">ถัดไป / Next</h4>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">รอเรียก / Waiting to be called</p>
                            </div>
                            <div style="text-align: right;">
                                <span style="background: #FEF3C7; color: #92400e; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; font-weight: 600; white-space: nowrap;">รอเรียก / Waiting</span>
                                <div style="margin-top: 0.25rem; color: var(--text-secondary); font-size: 0.875rem;">~12 นาที / min</div>
                            </div>
                        </div>

                        <div class="queue-item" style="padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border-gray);">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-secondary); min-width: 80px;">A-040</div>
                            <div style="flex: 1; padding: 0 1rem;">
                                <h4 style="margin: 0 0 0.25rem 0; font-size: 1rem;">รอคิว / In Queue</h4>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">แผนก OPD / Outpatient</p>
                            </div>
                            <div style="text-align: right;">
                                <span style="background: #FEF3C7; color: #92400e; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; font-weight: 600; white-space: nowrap;">รอคิว / Waiting</span>
                                <div style="margin-top: 0.25rem; color: var(--text-secondary); font-size: 0.875rem;">~14 นาที / min</div>
                            </div>
                        </div>

                        <div class="queue-item" style="padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border-gray);">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-secondary); min-width: 80px;">A-041</div>
                            <div style="flex: 1; padding: 0 1rem;">
                                <h4 style="margin: 0 0 0.25rem 0; font-size: 1rem;">รอคิว / In Queue</h4>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">แผนก OPD / Outpatient</p>
                            </div>
                            <div style="text-align: right;">
                                <span style="background: #FEF3C7; color: #92400e; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; font-weight: 600; white-space: nowrap;">รอคิว / Waiting</span>
                                <div style="margin-top: 0.25rem; color: var(--text-secondary); font-size: 0.875rem;">~15 นาที / min</div>
                            </div>
                        </div>

                        <div class="queue-item" style="background-color: #FEF3C7; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; border: 3px solid var(--gold-nav);">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--gold-nav); min-width: 80px;">A-042</div>
                            <div style="flex: 1; padding: 0 1rem;">
                                <h4 style="margin: 0 0 0.25rem 0; font-size: 1rem; color: var(--gold-nav);">คุณ / YOU</h4>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;"><strong>นาย สมศักดิ์ ใจดี</strong> - แผนก OPD</p>
                            </div>
                            <div style="text-align: right;">
                                <span style="background: #F59E0B; color: white; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; font-weight: 600; white-space: nowrap;">รอคิว / Waiting</span>
                                <div style="margin-top: 0.25rem; color: var(--gold-nav); font-size: 0.875rem; font-weight: 600;">~15 นาที / min</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Today's Appointment Details -->
                <div class="card" style="margin-top: 2rem;">
                    <div class="card-header">
                        <h3 class="card-title">รายละเอียดการนัดหมายวันนี้ / Today's Appointment</h3>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                        <div>
                            <h4 style="color: var(--text-secondary); font-size: 1rem; margin-bottom: 0.5rem;">แพทย์ / Doctor</h4>
                            <p style="font-size: 1.25rem; font-weight: 600; margin: 0;">นพ. สมชาย วรรณสุข</p>
                            <p style="font-size: 1rem; color: var(--text-secondary); margin: 0.25rem 0 0 0;">Dr. Somchai Wannasuk</p>
                        </div>
                        <div>
                            <h4 style="color: var(--text-secondary); font-size: 1rem; margin-bottom: 0.5rem;">แผนก / Department</h4>
                            <p style="font-size: 1.25rem; font-weight: 600; margin: 0;">อายุรกรรม / Internal Medicine</p>
                            <p style="font-size: 1rem; color: var(--text-secondary); margin: 0.25rem 0 0 0;">Outpatient Department (OPD)</p>
                        </div>
                        <div>
                            <h4 style="color: var(--text-secondary); font-size: 1rem; margin-bottom: 0.5rem;">เวลานัด / Appointment Time</h4>
                            <p style="font-size: 1.25rem; font-weight: 600; margin: 0;">10:30 น. / AM</p>
                            <p style="font-size: 1rem; color: var(--text-secondary); margin: 0.25rem 0 0 0;">14 กุมภาพันธ์ 2026</p>
                        </div>
                        <div>
                            <h4 style="color: var(--text-secondary); font-size: 1rem; margin-bottom: 0.5rem;">ห้องตรวจ / Room</h4>
                            <p style="font-size: 1.25rem; font-weight: 600; margin: 0;">ห้อง 3 / Room 3</p>
                            <p style="font-size: 1rem; color: var(--text-secondary); margin: 0.25rem 0 0 0;">ชั้น 2 อาคาร OPD</p>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="refreshQueue()">
                        รีเฟรชข้อมูล / Refresh
                    </button>
                    <button class="btn btn-secondary" onclick="alert('การแจ้งเตือนเปิดอยู่แล้ว / Notifications are enabled')">
                        เปิดการแจ้งเตือน / Enable Notifications
                    </button>
                    <button class="btn btn-gold" onclick="window.print()">
                        พิมพ์ใบคิว / Print Queue Number
                    </button>
                </div>
            `;
        }

        // Refresh queue
        function refreshQueue() {
            alert('กำลังรีเฟรชข้อมูล... / Refreshing data...\n\nข้อมูลคิวได้รับการอัพเดทแล้ว / Queue data updated');
            showQueue();
        }

        // Show Progress
        function showProgress() {
            updateActiveMenu('progressLink');
            
            document.getElementById('mainContent').innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.25rem; flex-wrap: wrap;">
                    <button onclick="showOverview()" style="background: var(--mfu-green); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 0.4rem; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.background='var(--mfu-green-dark)'; this.style.transform='translateX(-3px)'" onmouseout="this.style.background='var(--mfu-green)'; this.style.transform='translateX(0)'">
                        <span style="font-size: 1.1rem;">←</span>
                        <span>กลับ / Back</span>
                    </button>
                    <h2 style="color: var(--mfu-green); margin: 0;">ตรวจสอบความคืบหน้า / Check Progress</h2>
                </div>
                
                <!-- Progress Timeline -->
                <div class="card" style="background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%); border-left: 6px solid var(--mfu-green);">
                    <h3 style="color: var(--mfu-green); margin-bottom: 1.5rem;">สถานะการรักษาของคุณ / Your Treatment Progress</h3>
                    
                    <div style="position: relative; padding-left: 2rem;">
                        <!-- Timeline Item 1 - Completed -->
                        <div style="position: relative; padding-bottom: 2rem;">
                            <div style="position: absolute; left: -2rem; top: 0; width: 20px; height: 20px; background: var(--mfu-green); border-radius: 50%; border: 3px solid white; box-shadow: 0 0 0 2px var(--mfu-green);"></div>
                            <div style="position: absolute; left: -1.5rem; top: 20px; width: 2px; height: calc(100% - 20px); background: var(--mfu-green);"></div>
                            <div style="background: #d1fae5; padding: 1rem; border-radius: 8px; border-left: 4px solid var(--mfu-green);">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                    <h4 style="margin: 0; color: var(--mfu-green);">ลงทะเบียน / Registration</h4>
                                    <span style="background: var(--mfu-green); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem;">เสร็จสิ้น / Completed</span>
                                </div>
                                <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary);">เวลา: 09:00 น. / Time: 09:00 AM</p>
                                <p style="margin: 0.25rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">ลงทะเบียนเรียบร้อยแล้ว / Successfully registered</p>
                            </div>
                        </div>

                        <!-- Timeline Item 2 - Completed -->
                        <div style="position: relative; padding-bottom: 2rem;">
                            <div style="position: absolute; left: -2rem; top: 0; width: 20px; height: 20px; background: var(--mfu-green); border-radius: 50%; border: 3px solid white; box-shadow: 0 0 0 2px var(--mfu-green);"></div>
                            <div style="position: absolute; left: -1.5rem; top: 20px; width: 2px; height: calc(100% - 20px); background: var(--mfu-green);"></div>
                            <div style="background: #d1fae5; padding: 1rem; border-radius: 8px; border-left: 4px solid var(--mfu-green);">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                    <h4 style="margin: 0; color: var(--mfu-green);">ตรวจร่างกาย / Physical Examination</h4>
                                    <span style="background: var(--mfu-green); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem;">เสร็จสิ้น / Completed</span>
                                </div>
                                <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary);">เวลา: 09:10 น. / Time: 09:10 AM</p>
                                <p style="margin: 0.25rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">ตรวจร่างกายเรียบร้อย / Examination completed</p>
                            </div>
                        </div>

                        <!-- Timeline Item 3 - In Progress -->
                        <div style="position: relative; padding-bottom: 2rem;">
                            <div style="position: absolute; left: -2rem; top: 0; width: 20px; height: 20px; background: #3B82F6; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 0 2px #3B82F6;"></div>
                            <div style="position: absolute; left: -1.5rem; top: 20px; width: 2px; height: calc(100% - 20px); background: var(--mfu-green);"></div>
                            <div style="background: #dbeafe; padding: 1rem; border-radius: 8px; border-left: 4px solid #3B82F6;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                    <h4 style="margin: 0; color: #3B82F6;">รอพบแพทย์ / Waiting for Doctor</h4>
                                    <span style="background: #3B82F6; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem;">กำลังดำเนินการ / In Progress</span>
                                </div>
                                <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary);">คิวของคุณ: A-042 / Your Queue: A-042</p>
                                <p style="margin: 0.25rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">เหลืออีก 4 คน ประมาณ 15 นาที / 4 patients ahead, about 15 minutes</p>
                            </div>
                        </div>

                        <!-- Timeline Item 4 - Pending -->
                        <div style="position: relative; padding-bottom: 2rem;">
                            <div style="position: absolute; left: -2rem; top: 0; width: 20px; height: 20px; background: #e5e7eb; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 0 2px #e5e7eb;"></div>
                            <div style="position: absolute; left: -1.5rem; top: 20px; width: 2px; height: calc(100% - 20px); background: #e5e7eb;"></div>
                            <div style="background: #f9fafb; padding: 1rem; border-radius: 8px; border-left: 4px solid #e5e7eb;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                    <h4 style="margin: 0; color: var(--text-secondary);">ชำระเงิน / Payment</h4>
                                    <span style="background: #e5e7eb; color: var(--text-secondary); padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem;">รอดำเนินการ / Pending</span>
                                </div>
                                <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">รอชำระค่าบริการ / Waiting for payment</p>
                            </div>
                        </div>

                        <!-- Timeline Item 5 - Pending -->
                        <div style="position: relative; padding-bottom: 2rem;">
                            <div style="position: absolute; left: -2rem; top: 0; width: 20px; height: 20px; background: #e5e7eb; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 0 2px #e5e7eb;"></div>
                            <div style="position: absolute; left: -1.5rem; top: 20px; width: 2px; height: calc(100% - 20px); background: #e5e7eb;"></div>
                            <div style="background: #f9fafb; padding: 1rem; border-radius: 8px; border-left: 4px solid #e5e7eb;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                    <h4 style="margin: 0; color: var(--text-secondary);">ร้านยา / Pharmacy</h4>
                                    <span style="background: #e5e7eb; color: var(--text-secondary); padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem;">รอดำเนินการ / Pending</span>
                                </div>
                                <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">รับยา / Receive medication</p>
                            </div>
                        </div>

                        <!-- Timeline Item 6 - Pending -->
                        <div style="position: relative;">
                            <div style="position: absolute; left: -2rem; top: 0; width: 20px; height: 20px; background: #e5e7eb; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 0 2px #e5e7eb;"></div>
                            <div style="background: #f9fafb; padding: 1rem; border-radius: 8px; border-left: 4px solid #e5e7eb;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                    <h4 style="margin: 0; color: var(--text-secondary);">เสร็จสิ้น / Completion</h4>
                                    <span style="background: #e5e7eb; color: var(--text-secondary); padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem;">รอดำเนินการ / Pending</span>
                                </div>
                                <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">รับคำแนะนำ / Receive instructions</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Summary Card -->
                <div class="card" style="margin-top: 2rem; background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%);">
                    <h3 style="color: #3B82F6; margin-bottom: 1rem;">สรุป / Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div style="text-align: center; padding: 1rem; background: white; border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--mfu-green);">2/6</div>
                            <div style="font-size: 0.95rem; color: var(--text-secondary); margin-top: 0.5rem;">ขั้นตอนที่เสร็จแล้ว<br>Steps Completed</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: white; border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: 700; color: #3B82F6;">1</div>
                            <div style="font-size: 0.95rem; color: var(--text-secondary); margin-top: 0.5rem;">กำลังดำเนินการ<br>In Progress</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: white; border-radius: 8px;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--text-secondary);">2</div>
                            <div style="font-size: 0.95rem; color: var(--text-secondary); margin-top: 0.5rem;">รอดำเนินการ<br>Pending</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Show Doctor Instructions
        function showInstructions() {
            updateActiveMenu('instructionsLink');
            
            document.getElementById('mainContent').innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.25rem; flex-wrap: wrap;">
                    <button onclick="showOverview()" style="background: var(--mfu-green); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 0.4rem; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.background='var(--mfu-green-dark)'; this.style.transform='translateX(-3px)'" onmouseout="this.style.background='var(--mfu-green)'; this.style.transform='translateX(0)'">
                        <span style="font-size: 1.1rem;">←</span>
                        <span>กลับ / Back</span>
                    </button>
                    <h2 style="color: var(--mfu-green); margin: 0;">คำแนะนำแพทย์ / Doctor Instructions</h2>
                </div>
                
                <!-- Current Instructions -->
                <div class="card" style="background: linear-gradient(135deg, #ffffff 0%, #fef3c7 100%); border-left: 6px solid var(--gold-nav);">
                    <h3 style="color: var(--gold-nav); margin-bottom: 1rem;">คำแนะนำล่าสุด / Latest Instructions</h3>
                    <div style="background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <h4 style="margin: 0; color: var(--mfu-green);">นพ. สมชาย วรรณสุข / Somchai Wannasuk</h4>
                                <p style="margin: 0.25rem 0 0 0; color: var(--text-secondary); font-size: 0.95rem;">แผนกอายุรกรรม / Internal Medicine</p>
                            </div>
                            <span style="background: #3B82F6; color: white; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem;">รอพบแพทย์ / Waiting</span>
                        </div>
                        <div style="padding: 1rem; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3B82F6;">
                            <p style="margin: 0; color: var(--text-secondary);">คำแนะนำจะปรากฏหลังจากพบแพทย์</p>
                            <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;"><em>Instructions will appear after consultation</em></p>
                        </div>
                    </div>
                </div>

                <!-- Previous Instructions -->
                <div class="card" style="margin-top: 2rem;">
                    <div class="card-header">
                        <h3 class="card-title">คำแนะนำก่อนหน้า / Previous Instructions</h3>
                    </div>
                    
                    <!-- Instruction 1 -->
                    <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-gray);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <h4 style="margin: 0; color: var(--mfu-green);">พญ. มาลี สุขใจ / Malee Sukchai</h4>
                                <p style="margin: 0.25rem 0 0 0; color: var(--text-secondary); font-size: 0.95rem;">แผนกอายุรกรรม / Internal Medicine</p>
                            </div>
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">7 ม.ค. 2026 / Jan 7, 2026</span>
                        </div>
                        <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; border-left: 4px solid var(--mfu-green);">
                            <h5 style="margin: 0 0 0.5rem 0; color: var(--mfu-green);">การรักษา / Treatment:</h5>
                            <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: var(--text-secondary);">
                                <li>รับประทานยาลดไข้ วันละ 3 ครั้ง หลังอาหาร / Fever medication 3 times daily after meals</li>
                                <li>พักผ่อนให้เพียงพอ / Get adequate rest</li>
                                <li>ดื่มน้ำมากๆ / Drink plenty of water</li>
                            </ul>
                            <h5 style="margin: 1rem 0 0.5rem 0; color: var(--mfu-green);">นัดครั้งถัดไป / Next Appointment:</h5>
                            <p style="margin: 0; color: var(--text-secondary);">14 ม.ค. 2026 เวลา 10:00 น. / Jan 14, 2026 at 10:00 AM</p>
                        </div>
                    </div>

                    <!-- Instruction 2 -->
                    <div style="padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <h4 style="margin: 0; color: var(--mfu-green);">นพ. วิชัย เก่งการ / Wichai Kengkan</h4>
                                <p style="margin: 0.25rem 0 0 0; color: var(--text-secondary); font-size: 0.95rem;">แผนกทันตกรรม / Dental</p>
                            </div>
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">20 ธ.ค. 2025 / Dec 20, 2025</span>
                        </div>
                        <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; border-left: 4px solid var(--mfu-green);">
                            <h5 style="margin: 0 0 0.5rem 0; color: var(--mfu-green);">การรักษา / Treatment:</h5>
                            <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: var(--text-secondary);">
                                <li>อุดฟันเรียบร้อยแล้ว / Filling completed</li>
                                <li>หลีกเลี่ยงอาหารแข็งด้านที่อุด 24 ชม. / Avoid hard food on filled side for 24 hours</li>
                                <li>แปรงฟันวันละ 2 ครั้ง / Brush teeth twice daily</li>
                            </ul>
                            <h5 style="margin: 1rem 0 0.5rem 0; color: var(--mfu-green);">นัดครั้งถัดไป / Next Appointment:</h5>
                            <p style="margin: 0; color: var(--text-secondary);">ไม่มีนัด กรณีมีอาการติดต่อโรงพยาบาล / No appointment, contact if symptoms occur</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Show Patient History
        async function showPatientHistory() {
            updateActiveMenu('historyLink');
            
            document.getElementById('mainContent').innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.25rem; flex-wrap: wrap;">
                    <button onclick="showOverview()" style="background: var(--mfu-green); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 0.4rem; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.background='var(--mfu-green-dark)'; this.style.transform='translateX(-3px)'" onmouseout="this.style.background='var(--mfu-green)'; this.style.transform='translateX(0)'">
                        <span style="font-size: 1.1rem;">←</span>
                        <span>กลับ / Back</span>
                    </button>
                    <h2 style="color: var(--mfu-green); margin: 0;">ประวัติการรักษา / Medical History</h2>
                </div>
                
                <!-- Search Section -->
                <div class="card" style="background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%); border-left: 6px solid #3B82F6; margin-bottom: 2rem;">
                    <h3 style="color: #3B82F6; margin-bottom: 1rem;">ค้นหาประวัติผู้ป่วย / Search Patient Records</h3>
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                        <input 
                            type="text" 
                            id="patientSearchInput" 
                            placeholder="ค้นหาด้วยชื่อหรือเลขประจำตัว / Search by name or ID number"
                            style="flex: 1; padding: 0.75rem; border: 2px solid var(--border-gray); border-radius: 8px; font-size: 1rem;"
                        />
                        <button 
                            class="btn btn-primary" 
                            onclick="searchPatientsHistory()" 
                            style="padding: 0.75rem 2rem;">
                            ค้นหา / Search
                        </button>
                    </div>
                    <div id="searchResults" style="margin-top: 1rem;"></div>
                </div>

                <!-- Current Patient History -->
                <div id="patientHistoryContent">
                    <div class="card">
                        <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                            <h3 style="color: var(--text-secondary);">ค้นหาผู้ป่วยเพื่อดูประวัติ / Search for a patient to view history</h3>
                            <p>ใช้กล่องค้นหาด้านบนเพื่อค้นหาข้อมูลผู้ป่วยจากฐานข้อมูล</p>
                            <p><em>Use the search box above to find patient records from database</em></p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Search patients from database
        async function searchPatientsHistory() {
            const searchTerm = document.getElementById('patientSearchInput').value.trim();
            const searchResults = document.getElementById('searchResults');
            
            if (!searchTerm) {
                searchResults.innerHTML = `
                    <div style="padding: 1rem; background: #fef3c7; border-radius: 8px; color: #92400e;">
                        ⚠️ กรุณาใส่ชื่อหรือเลขประจำตัวผู้ป่วย / Please enter patient name or ID number
                    </div>
                `;
                return;
            }

            searchResults.innerHTML = `
                <div style="padding: 1rem; text-align: center; color: var(--text-secondary);">
                    <div style="display: inline-block; width: 24px; height: 24px; border: 3px solid #3B82F6; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="margin-top: 0.5rem;">กำลังค้นหา... / Searching...</p>
                </div>
            `;

            try {
                // Initialize database service if not already done
                if (!window.databaseService.supabase) {
                    await window.databaseService.init();
                }

                const result = await window.databaseService.searchPatients(searchTerm);
                
                if (!result.success) {
                    searchResults.innerHTML = `
                        <div style="padding: 1rem; background: #fee; border-radius: 8px; color: #c00;">
                            ❌ เกิดข้อผิดพลาด: ${result.error}
                        </div>
                    `;
                    return;
                }

                if (result.data.length === 0) {
                    searchResults.innerHTML = `
                        <div style="padding: 1rem; background: #f0f9ff; border-radius: 8px; color: var(--text-secondary);">
                            ℹ️ ไม่พบข้อมูลผู้ป่วย / No patient records found
                        </div>
                    `;
                    return;
                }

                // Display search results
                let resultsHTML = '<div style="margin-top: 1rem;"><h4 style="color: var(--mfu-green); margin-bottom: 1rem;">ผลการค้นหา / Search Results:</h4>';
                
                result.data.forEach(patient => {
                    const statusColor = patient.status === 'active' ? 'var(--mfu-green)' : 
                                       patient.status === 'in_treatment' ? '#3B82F6' : '#6B7280';
                    // Support different column names (name, full_name, patient_name)
                    const patientName = patient.name || patient.full_name || patient.patient_name || 'Unknown';
                    resultsHTML += `
                        <div style="padding: 1rem; background: white; border: 2px solid var(--border-gray); border-radius: 8px; margin-bottom: 1rem; cursor: pointer; transition: all 0.3s;"
                             onclick="viewPatientHistory('${patient.id}')"
                             onmouseover="this.style.borderColor='#3B82F6'; this.style.transform='translateY(-2px)'"
                             onmouseout="this.style.borderColor='var(--border-gray)'; this.style.transform='translateY(0)'">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <h4 style="margin: 0; color: var(--mfu-green);">${patientName}</h4>
                                    <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.95rem;">
                                        ID: ${patient.id_number || patient.id || 'N/A'} | 
                                        ${patient.gender || 'N/A'} | 
                                        ${patient.date_of_birth || patient.dob || 'N/A'}
                                    </p>
                                    <p style="margin: 0.25rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">
                                        ${patient.phone || ''} ${patient.email ? '| ' + patient.email : ''}
                                    </p>
                                </div>
                                <div style="text-align: right;">
                                    <span style="background: ${statusColor}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem;">
                                        ${patient.status}
                                    </span>
                                    <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.875rem;">
                                        ${patient.current_department || 'No department'}
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                resultsHTML += '</div>';
                searchResults.innerHTML = resultsHTML;

            } catch (error) {
                console.error('Error searching patients:', error);
                searchResults.innerHTML = `
                    <div style="padding: 1rem; background: #fee; border-radius: 8px; color: #c00;">
                        ❌ เกิดข้อผิดพลาด: ${error.message}
                    </div>
                `;
            }
        }

        // View full patient history
        async function viewPatientHistory(patientId) {
            const historyContent = document.getElementById('patientHistoryContent');
            
            historyContent.innerHTML = `
                <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                    <div style="display: inline-block; width: 48px; height: 48px; border: 4px solid var(--mfu-green); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="margin-top: 1rem; font-size: 1.125rem;">กำลังโหลดประวัติผู้ป่วย... / Loading patient history...</p>
                </div>
            `;

            try {
                const result = await window.databaseService.getPatientFullHistory(patientId);
                
                if (!result.success) {
                    historyContent.innerHTML = `
                        <div class="card">
                            <div style="padding: 2rem; background: #fee; border-radius: 8px; color: #c00; text-align: center;">
                                ❌ <strong>เกิดข้อผิดพลาด / Error:</strong> ${result.error}
                            </div>
                        </div>
                    `;
                    return;
                }

                const { patient, appointments, queueHistory } = result.data;
                
                // Support flexible column names
                const patientName = patient.name || patient.full_name || patient.patient_name || 'Unknown';
                const patientId = patient.id_number || patient.id || 'N/A';
                const patientDob = patient.date_of_birth || patient.dob || 'N/A';
                
                // Build patient history display
                let historyHTML = `
                    <!-- Patient Info Card -->
                    <div class="card" style="background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%); border-left: 6px solid var(--mfu-green); margin-bottom: 2rem;">
                        <h3 style="color: var(--mfu-green); margin-bottom: 1.5rem;">ข้อมูลผู้ป่วย / Patient Information</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                            <div>
                                <h4 style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">ชื่อ-นามสกุล / Full Name</h4>
                                <p style="font-size: 1.125rem; font-weight: 600; margin: 0;">${patientName}</p>
                            </div>
                            <div>
                                <h4 style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">เลขประจำตัว / ID Number</h4>
                                <p style="font-size: 1.125rem; font-weight: 600; margin: 0;">${patientId}</p>
                            </div>
                            <div>
                                <h4 style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">วันเกิด / Date of Birth</h4>
                                <p style="font-size: 1.125rem; font-weight: 600; margin: 0;">${patientDob}</p>
                            </div>
                            <div>
                                <h4 style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">เพศ / Gender</h4>
                                <p style="font-size: 1.125rem; font-weight: 600; margin: 0;">${patient.gender || 'N/A'}</p>
                            </div>
                            <div>
                                <h4 style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">กรุ๊ปเลือด / Blood Type</h4>
                                <p style="font-size: 1.125rem; font-weight: 600; margin: 0;">${patient.blood_type || 'N/A'}</p>
                            </div>
                            <div>
                                <h4 style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">สถานะ / Status</h4>
                                <p style="font-size: 1.125rem; font-weight: 600; margin: 0; color: var(--mfu-green);">${patient.status || 'N/A'}</p>
                            </div>
                        </div>
                        ${patient.allergies && patient.allergies.length > 0 ? `
                            <div style="margin-top: 1.5rem; padding: 1rem; background: #fef3c7; border-radius: 8px; border-left: 4px solid #F59E0B;">
                                <h4 style="color: #92400e; margin: 0 0 0.5rem 0;">⚠️ ประวัติการแพ้ / Allergies</h4>
                                <p style="margin: 0; color: #78350f;">${patient.allergies.join(', ')}</p>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Appointments History -->
                    <div class="card" style="margin-bottom: 2rem;">
                        <div class="card-header">
                            <h3 class="card-title">ประวัติการนัดหมาย / Appointment History (${appointments.length})</h3>
                        </div>
                        ${appointments.length > 0 ? `
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead style="background: var(--mfu-green); color: white;">
                                        <tr>
                                            <th style="padding: 0.75rem; text-align: left;">วันที่ / Date</th>
                                            <th style="padding: 0.75rem; text-align: left;">เวลา / Time</th>
                                            <th style="padding: 0.75rem; text-align: left;">แผนก / Department</th>
                                            <th style="padding: 0.75rem; text-align: left;">ประเภท / Type</th>
                                            <th style="padding: 0.75rem; text-align: center;">สถานะ / Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${appointments.map((apt, idx) => `
                                            <tr style="border-bottom: 1px solid var(--border-gray); ${idx % 2 === 0 ? 'background: #f9fafb;' : ''}">
                                                <td style="padding: 0.75rem;">${apt.appointment_date}</td>
                                                <td style="padding: 0.75rem;">${apt.appointment_time}</td>
                                                <td style="padding: 0.75rem;">${apt.department}</td>
                                                <td style="padding: 0.75rem;">${apt.appointment_type || '-'}</td>
                                                <td style="padding: 0.75rem; text-align: center;">
                                                    <span style="background: ${apt.status === 'completed' ? 'var(--mfu-green)' : apt.status === 'cancelled' ? '#EF4444' : '#3B82F6'}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem;">
                                                        ${apt.status}
                                                    </span>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                            <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                                <p>ไม่มีประวัติการนัดหมาย / No appointment history</p>
                            </div>
                        `}
                    </div>

                    <!-- Queue History -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ประวัติการเข้าคิว / Queue History (${queueHistory.length})</h3>
                        </div>
                        ${queueHistory.length > 0 ? `
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead style="background: var(--mfu-green); color: white;">
                                        <tr>
                                            <th style="padding: 0.75rem; text-align: left;">หมายเลขคิว / Queue No.</th>
                                            <th style="padding: 0.75rem; text-align: left;">แผนก / Department</th>
                                            <th style="padding: 0.75rem; text-align: left;">เช็คอิน / Check-in</th>
                                            <th style="padding: 0.75rem; text-align: center;">ลำดับความสำคัญ / Priority</th>
                                            <th style="padding: 0.75rem; text-align: center;">สถานะ / Status</th>
                                            <th style="padding: 0.75rem; text-align: right;">เวลารอ (นาที) / Wait Time</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${queueHistory.map((queue, idx) => `
                                            <tr style="border-bottom: 1px solid var(--border-gray); ${idx % 2 === 0 ? 'background: #f9fafb;' : ''}">
                                                <td style="padding: 0.75rem; font-weight: 700;">${queue.queue_number}</td>
                                                <td style="padding: 0.75rem;">${queue.department}</td>
                                                <td style="padding: 0.75rem;">${new Date(queue.checked_in_at).toLocaleString('th-TH')}</td>
                                                <td style="padding: 0.75rem; text-align: center;">
                                                    <span style="background: ${queue.priority === 'emergency' ? '#EF4444' : queue.priority === 'urgent' ? '#F59E0B' : '#6B7280'}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem;">
                                                        ${queue.priority}
                                                    </span>
                                                </td>
                                                <td style="padding: 0.75rem; text-align: center;">
                                                    <span style="background: ${queue.status === 'completed' ? 'var(--mfu-green)' : queue.status === 'cancelled' ? '#EF4444' : '#3B82F6'}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem;">
                                                        ${queue.status}
                                                    </span>
                                                </td>
                                                <td style="padding: 0.75rem; text-align: right;">${queue.estimated_wait_time || '-'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                            <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                                <p>ไม่มีประวัติการเข้าคิว / No queue history</p>
                            </div>
                        `}
                    </div>
                `;

                historyContent.innerHTML = historyHTML;

            } catch (error) {
                console.error('Error loading patient history:', error);
                historyContent.innerHTML = `
                    <div class="card">
                        <div style="padding: 2rem; background: #fee; border-radius: 8px; color: #c00; text-align: center;">
                            ❌ <strong>เกิดข้อผิดพลาด / Error:</strong> ${error.message}
                        </div>
                    </div>
                `;
            }
        }

        // Show AI Wait Time & Notifications
        function showWaitTime() {
            updateActiveMenu('waittimeLink');
            
            document.getElementById('mainContent').innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.25rem; flex-wrap: wrap;">
                    <button onclick="showOverview()" style="background: var(--mfu-green); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 0.4rem; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.background='var(--mfu-green-dark)'; this.style.transform='translateX(-3px)'" onmouseout="this.style.background='var(--mfu-green)'; this.style.transform='translateX(0)'">
                        <span style="font-size: 1.1rem;">←</span>
                        <span>กลับ / Back</span>
                    </button>
                    <h2 style="color: var(--mfu-green); margin: 0;">เวลารอ AI & การแจ้งเตือน / AI Wait Time & Notifications</h2>
                </div>
                
                <!-- AI Prediction Card -->
                <div class="card" style="background: linear-gradient(135deg, #ffffff 0%, #eff6ff 100%); border-left: 6px solid #3B82F6;">
                    <h3 style="color: #3B82F6; margin-bottom: 1rem;">การทำนายเวลารอ AI / AI Wait Time Prediction</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div style="text-align: center; padding: 1.5rem; background: white; border-radius: 8px; border: 2px solid #3B82F6;">
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">เวลารอปัจจุบัน / Current Wait</div>
                            <div style="font-size: 3.5rem; font-weight: 700; color: #3B82F6; line-height: 1;">15</div>
                            <div style="font-size: 1.25rem; color: var(--text-secondary); margin-top: 0.25rem;">นาที / minutes</div>
                        </div>
                        <div style="text-align: center; padding: 1.5rem; background: white; border-radius: 8px;">
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">ความแม่นยำ / Accuracy</div>
                            <div style="font-size: 3.5rem; font-weight: 700; color: var(--mfu-green); line-height: 1;">94.2%</div>
                        </div>
                        <div style="text-align: center; padding: 1.5rem; background: white; border-radius: 8px;">
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">คนในคิว / In Queue</div>
                            <div style="font-size: 3.5rem; font-weight: 700; color: var(--gold-nav); line-height: 1;">4</div>
                            <div style="font-size: 1.25rem; color: var(--text-secondary); margin-top: 0.25rem;">คน / people</div>
                        </div>
                    </div>

                    <div style="background: white; padding: 1.5rem; border-radius: 8px;">
                        <h4 style="color: #3B82F6; margin: 0 0 1rem 0;">ปัจจัยที่ใช้ในการทำนาย / Prediction Factors</h4>
                        <div style="display: grid; gap: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 40px; height: 40px; background: #dbeafe; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #3B82F6; font-weight: 700;">4</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--text-secondary);">จำนวนผู้ป่วยข้างหน้า / Patients ahead</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 40px; height: 40px; background: #dbeafe; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #3B82F6; font-size: 0.875rem; font-weight: 700;">12m</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--text-secondary);">เวลาเฉลี่ยต่อคน / Average time per patient</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 40px; height: 40px; background: #dbeafe; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #3B82F6; font-weight: 700;">OPD</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--text-secondary);">ประเภทแผนก / Department type</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notification Settings -->
                <div class="card" style="margin-top: 2rem;">
                    <div class="card-header">
                        <h3 class="card-title">การตั้งค่าการแจ้งเตือน / Notification Settings</h3>
                    </div>
                    
                    <div style="padding: 1rem; background: #d1fae5; border-radius: 8px; margin-bottom: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div style="width: 40px; height: 40px; background: var(--mfu-green); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">ON</div>
                            <div>
                                <div style="font-weight: 600; color: #065f46;">การแจ้งเตือนเปิดอยู่ / Notifications Enabled</div>
                                <div style="font-size: 0.9rem; color: #047857;">คุณจะได้รับการแจ้งเตือนเมื่อใกล้ถึงคิวของคุณ / You will be notified when your queue is near</div>
                            </div>
                        </div>
                    </div>

                    <div style="display: grid; gap: 1rem;">
                        <div style="padding: 1rem; background: #f9fafb; border-radius: 8px; border: 1px solid var(--border-gray);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="margin: 0 0 0.25rem 0; color: var(--mfu-green);">แจ้งเตือนเมื่อเหลือ 3 คน / Alert at 3 patients ahead</h4>
                                    <p style="margin: 0; font-size: 0.9rem; color: var(--text-secondary);">ประมาณ 8-10 นาที / Approximately 8-10 minutes</p>
                                </div>
                                <span style="background: var(--mfu-green); color: white; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; font-weight: 600;">เปิด / ON</span>
                            </div>
                        </div>

                        <div style="padding: 1rem; background: #f9fafb; border-radius: 8px; border: 1px solid var(--border-gray);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="margin: 0 0 0.25rem 0; color: var(--mfu-green);">แจ้งเตือนเมื่อเหลือ 1 คน / Alert at 1 patient ahead</h4>
                                    <p style="margin: 0; font-size: 0.9rem; color: var(--text-secondary);">ประมาณ 3-5 นาที / Approximately 3-5 minutes</p>
                                </div>
                                <span style="background: var(--mfu-green); color: white; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; font-weight: 600;">เปิด / ON</span>
                            </div>
                        </div>

                        <div style="padding: 1rem; background: #f9fafb; border-radius: 8px; border: 1px solid var(--border-gray);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="margin: 0 0 0.25rem 0; color: var(--mfu-green);">แจ้งเตือนถึงคิว / Alert when it's your turn</h4>
                                    <p style="margin: 0; font-size: 0.9rem; color: var(--text-secondary);">กรุณาเข้าห้องตรวจทันที / Please proceed to examination room</p>
                                </div>
                                <span style="background: var(--mfu-green); color: white; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; font-weight: 600;">เปิด / ON</span>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 1.5rem; padding: 1rem; background: #fef3c7; border-radius: 8px; border-left: 4px solid var(--gold-nav);">
                        <strong style="color: #92400e;">หมายเหตุ / Note:</strong>
                        <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.95rem;">
                            กรุณาเปิดการแจ้งเตือนในโทรศัพท์และอยู่ในพื้นที่โรงพยาบาล<br>
                            <em>Please enable phone notifications and stay within hospital area</em>
                        </p>
                    </div>
                </div>
            `;
        }

        // Show Map
        function showMap() {
            updateActiveMenu('mapLink');
            
            document.getElementById('mainContent').innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.25rem; flex-wrap: wrap;">
                    <button onclick="showOverview()" style="background: var(--mfu-green); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 0.4rem; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.background='var(--mfu-green-dark)'; this.style.transform='translateX(-3px)'" onmouseout="this.style.background='var(--mfu-green)'; this.style.transform='translateX(0)'">
                        <span style="font-size: 1.1rem;">←</span>
                        <span>กลับ / Back</span>
                    </button>
                    <h2 style="color: var(--mfu-green); margin: 0;">แผนที่โรงพยาบาล / Hospital Map</h2>
                </div>
                
                <!-- Map Card -->
                <div class="card" style="background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%); border-left: 6px solid var(--mfu-green);">
                    <h3 style="color: var(--mfu-green); margin-bottom: 1rem;">ตำแหน่งของคุณและห้องตรวจ / Your Location & Examination Room</h3>
                    
                    <!-- Map Placeholder -->
                    <div style="background: #f9fafb; border: 2px dashed var(--border-gray); border-radius: 8px; padding: 3rem; text-align: center; margin-bottom: 1.5rem;">
                        <h4 style="color: var(--text-secondary); margin-bottom: 0.5rem;">แผนที่ภายในโรงพยาบาล / Hospital Indoor Map</h4>
                        <p style="color: var(--text-secondary); font-size: 0.95rem;">แผนที่เชิงโต้ตอบจะแสดงที่นี่ / Interactive map will be displayed here</p>
                    </div>

                    <!-- Location Info -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 2px solid var(--mfu-green);">
                            <h4 style="color: var(--mfu-green); margin: 0 0 1rem 0;">ห้องตรวจของคุณ / Your Room</h4>
                            <div style="font-size: 2.5rem; font-weight: 700; color: var(--mfu-green); margin-bottom: 0.5rem;">ห้อง 3</div>
                            <div style="font-size: 1.25rem; color: var(--text-secondary);">Room 3</div>
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-gray);">
                                <p style="margin: 0; color: var(--text-secondary);">ชั้น 2 อาคาร OPD</p>
                                <p style="margin: 0.25rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">Floor 2, OPD Building</p>
                            </div>
                        </div>

                        <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border-gray);">
                            <h4 style="color: #3B82F6; margin: 0 0 1rem 0;">ระยะทาง / Distance</h4>
                            <div style="font-size: 2.5rem; font-weight: 700; color: #3B82F6; margin-bottom: 0.5rem;">50 ม.</div>
                            <div style="font-size: 1.25rem; color: var(--text-secondary);">50 meters</div>
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-gray);">
                                <p style="margin: 0; color: var(--text-secondary);">เวลาเดินประมาณ 2 นาที</p>
                                <p style="margin: 0.25rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">Approximately 2 min walk</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Directions -->
                <div class="card" style="margin-top: 2rem;">
                    <div class="card-header">
                        <h3 class="card-title">เส้นทาง / Directions</h3>
                    </div>
                    
                    <div style="display: grid; gap: 1rem;">
                        <div style="display: flex; gap: 1rem; padding: 1rem; background: #f0fdf4; border-radius: 8px;">
                            <div style="flex-shrink: 0; width: 40px; height: 40px; background: var(--mfu-green); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">1</div>
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--mfu-green);">จากตำแหน่งปัจจุบัน / From current location</h4>
                                <p style="margin: 0; color: var(--text-secondary);">เดินตรงไปทางลิฟต์ / Walk straight towards the elevator</p>
                            </div>
                        </div>

                        <div style="display: flex; gap: 1rem; padding: 1rem; background: #f0fdf4; border-radius: 8px;">
                            <div style="flex-shrink: 0; width: 40px; height: 40px; background: var(--mfu-green); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">2</div>
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--mfu-green);">ขึ้นลิฟต์ / Take elevator</h4>
                                <p style="margin: 0; color: var(--text-secondary);">ขึ้นชั้น 2 อาคาร OPD / Go to Floor 2, OPD Building</p>
                            </div>
                        </div>

                        <div style="display: flex; gap: 1rem; padding: 1rem; background: #f0fdf4; border-radius: 8px;">
                            <div style="flex-shrink: 0; width: 40px; height: 40px; background: var(--mfu-green); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">3</div>
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--mfu-green);">เลี้ยวขวา / Turn right</h4>
                                <p style="margin: 0; color: var(--text-secondary);">ออกจากลิฟต์แล้วเลี้ยวขวา / After exiting elevator, turn right</p>
                            </div>
                        </div>

                        <div style="display: flex; gap: 1rem; padding: 1rem; background: #d1fae5; border-radius: 8px; border: 2px solid var(--mfu-green);">
                            <div style="flex-shrink: 0; width: 40px; height: 40px; background: var(--mfu-green); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">4</div>
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--mfu-green);">ห้อง 3 อยู่ทางซ้ายมือ / Room 3 on your left</h4>
                                <p style="margin: 0; color: var(--text-secondary);">เดินประมาณ 20 เมตร / Walk approximately 20 meters</p>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            `;
        }

        // Show Smart Rescheduling
        function showSmartReschedule() {
            updateActiveMenu('rescheduleLink');
            
            document.getElementById('mainContent').innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.25rem; flex-wrap: wrap;">
                    <button onclick="showOverview()" style="background: var(--mfu-green); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 0.4rem; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.background='var(--mfu-green-dark)'; this.style.transform='translateX(-3px)'" onmouseout="this.style.background='var(--mfu-green)'; this.style.transform='translateX(0)'">
                        <span style="font-size: 1.1rem;">←</span>
                        <span>กลับ / Back</span>
                    </button>
                    <h2 style="color: var(--mfu-green); margin: 0;">นัดหมายอัจฉริยะ / Smart Rescheduling</h2>
                </div>
                
                <!-- No-Show Risk Alert -->
                <div class="card" style="background: linear-gradient(135deg, #ffffff 0%, #fef3c7 100%); border-left: 6px solid var(--gold-nav); margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                        <div style="width: 60px; height: 60px; background: var(--gold-nav); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.75rem; font-weight: 700; flex-shrink: 0;">⚠</div>
                        <div style="flex: 1; min-width: 250px;">
                            <h3 style="color: #92400e; margin: 0 0 0.5rem 0;">การวิเคราะห์ความเสี่ยงการไม่มา / No-Show Risk Analysis</h3>
                            <p style="color: var(--text-secondary); margin: 0; font-size: 1.05rem;">
                                ระบบ AI วิเคราะห์ประวัติของคุณและปัจจัยอื่นๆ เพื่อแนะนำเวลานัดที่เหมาะสม<br>
                                <em>AI analyzes your history and other factors to recommend optimal appointment times</em>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- No-Show Risk Score -->
                <div class="card" style="background: linear-gradient(135deg, #ffffff 0%, #eff6ff 100%); border-left: 6px solid #3B82F6; margin-bottom: 1.5rem;">
                    <h3 style="color: #3B82F6; margin-bottom: 1.5rem;">คะแนนความเสี่ยงการไม่มา / Your No-Show Risk Score</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                        <div style="text-align: center; padding: 1.5rem; background: white; border-radius: 8px; border: 2px solid #10b981;">
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">คะแนนความเสี่ยง / Risk Score</div>
                            <div style="font-size: 3.5rem; font-weight: 700; color: #10b981; line-height: 1;">12%</div>
                            <div style="font-size: 1rem; color: #10b981; margin-top: 0.5rem; font-weight: 600;">ต่ำ / LOW</div>
                        </div>
                        <div style="text-align: center; padding: 1.5rem; background: white; border-radius: 8px;">
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">ประวัติการมา / Attendance History</div>
                            <div style="font-size: 3.5rem; font-weight: 700; color: var(--mfu-green); line-height: 1;">94%</div>
                            <div style="font-size: 1rem; color: var(--text-secondary); margin-top: 0.5rem;">18/19 ครั้ง / visits</div>
                        </div>
                        <div style="text-align: center; padding: 1.5rem; background: white; border-radius: 8px;">
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">เวลานัดที่แนะนำ / Best Time Slot</div>
                            <div style="font-size: 2rem; font-weight: 700; color: #3B82F6; line-height: 1; margin-top: 0.5rem;">09:00-11:00</div>
                            <div style="font-size: 1rem; color: var(--text-secondary); margin-top: 0.5rem;">เช้า / Morning</div>
                        </div>
                    </div>

                    <!-- Risk Factors -->
                    <div style="background: white; padding: 1.5rem; border-radius: 8px;">
                        <h4 style="color: #3B82F6; margin: 0 0 1rem 0;">ปัจจัยที่ใช้วิเคราะห์ / Analysis Factors</h4>
                        <div style="display: grid; gap: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 40px; height: 40px; background: #d1fae5; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #10b981; font-weight: 700;">✓</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--text-secondary);">ประวัติการมาตรงเวลา / Punctual attendance history</div>
                                    <div style="font-size: 0.9rem; color: var(--text-secondary);">คุณมาตรงเวลา 94% ในการนัดหมายที่ผ่านมา</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 40px; height: 40px; background: #d1fae5; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #10b981; font-weight: 700;">🌤</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--text-secondary);">สภาพอากาศ / Weather conditions</div>
                                    <div style="font-size: 0.9rem; color: var(--text-secondary);">พยากรณ์อากาศดีในสัปดาห์นี้ / Good weather forecast this week</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 40px; height: 40px; background: #d1fae5; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #10b981; font-weight: 700;">📍</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--text-secondary);">ระยะทาง / Travel distance</div>
                                    <div style="font-size: 0.9rem; color: var(--text-secondary);">8.5 กม. จากบ้าน (ประมาณ 15 นาที) / 8.5 km from home (approx 15 min)</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 40px; height: 40px; background: #dbeafe; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #3B82F6; font-weight: 700;">⏰</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--text-secondary);">ช่วงเวลาที่เหมาะสม / Preferred time slot</div>
                                    <div style="font-size: 0.9rem; color: var(--text-secondary);">คุณมักมาช่วงเช้า (09:00-11:00) / You typically attend morning slots</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Smart Overbooking Recommendations -->
                <div class="card" style="background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%); border-left: 6px solid var(--mfu-green); margin-bottom: 1.5rem;">
                    <h3 style="color: var(--mfu-green); margin-bottom: 1.5rem;">คำแนะนำนัดหมายอัจฉริยะ / Smart Scheduling Recommendations</h3>
                    
                    <!-- Benefits Overview -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div style="text-align: center; padding: 1.5rem; background: white; border-radius: 8px; border: 2px solid var(--mfu-green);">
                            <div style="font-size: 1.75rem; font-weight: 700; color: var(--mfu-green); line-height: 1;">-28%</div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.5rem;">เวลารอลดลง<br>Reduced Wait Time</div>
                        </div>
                        <div style="text-align: center; padding: 1.5rem; background: white; border-radius: 8px; border: 2px solid #3B82F6;">
                            <div style="font-size: 1.75rem; font-weight: 700; color: #3B82F6; line-height: 1;">+35%</div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.5rem;">ใช้ทรัพยากรเพิ่ม<br>Higher Utilization</div>
                        </div>
                        <div style="text-align: center; padding: 1.5rem; background: white; border-radius: 8px; border: 2px solid var(--gold-nav);">
                            <div style="font-size: 1.75rem; font-weight: 700; color: var(--gold-nav); line-height: 1;">-42%</div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.5rem;">เวลาว่างลดลง<br>Reduced Idle Time</div>
                        </div>
                    </div>

                    <!-- Recommended Slots -->
                    <div style="background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <h4 style="color: var(--mfu-green); margin: 0 0 1rem 0;">เวลานัดที่แนะนำสำหรับคุณ / Recommended Appointment Slots</h4>
                        <div style="display: grid; gap: 1rem;">
                            <!-- Best Option -->
                            <div style="padding: 1.25rem; background: linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%); border-radius: 8px; border: 2px solid var(--mfu-green); position: relative;">
                                <div style="position: absolute; top: -12px; right: 12px; background: var(--mfu-green); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">แนะนำ / RECOMMENDED</div>
                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                                    <div>
                                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--mfu-green);">วันพุธ 20 ก.พ. 2026 เวลา 09:30</div>
                                        <div style="font-size: 1.125rem; color: #065f46; margin-top: 0.25rem;">Wednesday, Feb 20, 2026 at 09:30 AM</div>
                                        <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem; flex-wrap: wrap;">
                                            <span style="background: white; color: var(--mfu-green); padding: 0.35rem 0.75rem; border-radius: 6px; font-size: 0.875rem; font-weight: 600; border: 1px solid var(--mfu-green);">✓ เวลารอสั้น / Short wait</span>
                                            <span style="background: white; color: var(--mfu-green); padding: 0.35rem 0.75rem; border-radius: 6px; font-size: 0.875rem; font-weight: 600; border: 1px solid var(--mfu-green);">✓ อากาศดี / Good weather</span>
                                            <span style="background: white; color: var(--mfu-green); padding: 0.35rem 0.75rem; border-radius: 6px; font-size: 0.875rem; font-weight: 600; border: 1px solid var(--mfu-green);">✓ เวลาที่คุณชอบ / Your preferred time</span>
                                        </div>
                                    </div>
                                    <button onclick="confirmReschedule('2026-02-20', '09:30')" style="background: var(--mfu-green); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">เลือกเวลานี้<br>Select This</button>
                                </div>
                            </div>
                            
                            <!-- Alternative Options -->
                            <div style="padding: 1rem; background: #f9fafb; border-radius: 8px; border: 1px solid var(--border-gray);">
                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                                    <div>
                                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--text-secondary);">วันพฤหัสบดี 21 ก.พ. 2026 เวลา 10:00</div>
                                        <div style="font-size: 1rem; color: var(--text-secondary); margin-top: 0.25rem;">Thursday, Feb 21, 2026 at 10:00 AM</div>
                                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                                            <span style="background: white; color: var(--text-secondary); padding: 0.3rem 0.65rem; border-radius: 6px; font-size: 0.8rem; border: 1px solid var(--border-gray);">เวลารอปานกลาง / Medium wait</span>
                                        </div>
                                    </div>
                                    <button onclick="confirmReschedule('2026-02-21', '10:00')" style="background: white; color: var(--mfu-green); border: 2px solid var(--mfu-green); padding: 0.65rem 1.25rem; border-radius: 8px; cursor: pointer; font-size: 0.95rem; font-weight: 600; white-space: nowrap; transition: all 0.3s ease;" onmouseover="this.style.background='var(--mfu-green)'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='var(--mfu-green)'">เลือก / Select</button>
                                </div>
                            </div>

                            <div style="padding: 1rem; background: #f9fafb; border-radius: 8px; border: 1px solid var(--border-gray);">
                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                                    <div>
                                        <div style="font-size: 1.25rem; font-weight: 600; color: var(--text-secondary);">วันศุกร์ 22 ก.พ. 2026 เวลา 09:00</div>
                                        <div style="font-size: 1rem; color: var(--text-secondary); margin-top: 0.25rem;">Friday, Feb 22, 2026 at 09:00 AM</div>
                                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                                            <span style="background: white; color: var(--text-secondary); padding: 0.3rem 0.65rem; border-radius: 6px; font-size: 0.8rem; border: 1px solid var(--border-gray);">เวลารอสั้น / Short wait</span>
                                            <span style="background: white; color: var(--text-secondary); padding: 0.3rem 0.65rem; border-radius: 6px; font-size: 0.8rem; border: 1px solid var(--border-gray);">เช้าตรู่ / Early morning</span>
                                        </div>
                                    </div>
                                    <button onclick="confirmReschedule('2026-02-22', '09:00')" style="background: white; color: var(--mfu-green); border: 2px solid var(--mfu-green); padding: 0.65rem 1.25rem; border-radius: 8px; cursor: pointer; font-size: 0.95rem; font-weight: 600; white-space: nowrap; transition: all 0.3s ease;" onmouseover="this.style.background='var(--mfu-green)'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='var(--mfu-green)'">เลือก / Select</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- How It Works -->
                    <div style="background: #eff6ff; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #3B82F6;">
                        <h4 style="color: #1e40af; margin: 0 0 1rem 0;">ระบบนัดหมายอัจฉริยะทำงานอย่างไร / How Smart Overbooking Works</h4>
                        <div style="display: grid; gap: 0.75rem; color: var(--text-secondary); font-size: 0.95rem;">
                            <p style="margin: 0;">✓ วิเคราะห์ประวัติการมาของผู้ป่วยทุกคน / Analyzes all patients' attendance history</p>
                            <p style="margin: 0;">✓ คำนวณโอกาสที่ผู้ป่วยจะไม่มาตามนัด / Calculates no-show probability for each appointment</p>
                            <p style="margin: 0;">✓ แนะนำช่วงเวลาที่ปลอดภัยสำหรับการรับผู้ป่วยเพิ่ม / Recommends safe overbooking windows per doctor</p>
                            <p style="margin: 0;">✓ ลดเวลาว่างของแพทย์และเวลารอของผู้ป่วย / Reduces doctor idle time and patient wait times</p>
                            <p style="margin: 0;">✓ ปรับปรุงการใช้ทรัพยากรโรงพยาบาล / Improves overall hospital resource utilization</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Confirm reschedule function
        function confirmReschedule(date, time) {
            if (confirm(`ยืนยันการนัดหมายใหม่\n\nวันที่: ${date}\nเวลา: ${time}\n\nConfirm rescheduling?`)) {
                alert('✓ นัดหมายของคุณได้รับการอัปเดตแล้ว!\n\nYour appointment has been updated successfully!\n\nคุณจะได้รับอีเมลยืนยันในอีกสักครู่\nYou will receive a confirmation email shortly.');
                showSmartReschedule();
            }
        }
    </script>
</body>
</html>